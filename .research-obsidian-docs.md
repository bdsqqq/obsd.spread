# obsidian plugin developer documentation research

## 1. view class and custom views

### ItemView (standard views)
- extend `ItemView` from obsidian package
- requires `getViewType()` â†’ unique string identifier
- requires `getDisplayText()` â†’ human-readable name
- `onOpen()` â†’ called when view opens, build content here
- `onClose()` â†’ cleanup when view closes
- register with `this.registerView(VIEW_TYPE, (leaf) => new MyView(leaf))`
- access container via `this.contentEl`
- use `getLeavesOfType(VIEW_TYPE)` to find view instances

```typescript
import { ItemView, WorkspaceLeaf } from 'obsidian';

export const VIEW_TYPE_EXAMPLE = 'example-view';

export class ExampleView extends ItemView {
  constructor(leaf: WorkspaceLeaf) {
    super(leaf);
  }
  
  getViewType() { return VIEW_TYPE_EXAMPLE; }
  getDisplayText() { return 'Example view'; }
  
  async onOpen() {
    const container = this.contentEl;
    container.empty();
    container.createEl('h4', { text: 'Example view' });
  }
  
  async onClose() { }
}
```

### TextFileView (for file-backed views)
- extend `TextFileView` for views that display file content
- has `file` property pointing to current TFile
- used for custom file type editors

### FileView hierarchy
- View â†’ ItemView â†’ FileView â†’ TextFileView â†’ EditableFileView â†’ MarkdownView

## 2. registerExtensions and file type handling

### plugin.registerExtensions(extensions, viewType)
- associates file extensions with a view type
- `this.registerExtensions(['csv', 'tsv'], 'my-csv-view')`
- de-registering requires accessing internal app methods (not official api)

### community plugin example: custom-file-extensions-plugin
- uses `this.app.viewRegistry.registerExtensions()` 
- configuration: `{"markdown": ["", "txt", "html", "js", "css", "ts", "yaml", "md"]}`
- extensions are case-insensitive

### key consideration
- registerExtensions tells obsidian which view to open for file type
- must also register the view itself via registerView()

## 3. MarkdownPostProcessor api

### registerMarkdownPostProcessor
- transforms rendered markdown HTML in READING view (not live preview)
- callback receives `(element: HTMLElement, context: MarkdownPostProcessorContext)`
- runs AFTER markdown â†’ HTML conversion

```typescript
this.registerMarkdownPostProcessor((element, context) => {
  const codeblocks = element.findAll('code');
  for (let codeblock of codeblocks) {
    const text = codeblock.innerText.trim();
    // transform content
    codeblock.replaceWith(newElement);
  }
});
```

### registerMarkdownCodeBlockProcessor
- handles fenced code blocks of specific language
- `this.registerMarkdownCodeBlockProcessor('csv', (source, el, ctx) => {...})`
- receives raw source text, target element, context

```typescript
this.registerMarkdownCodeBlockProcessor('csv', (source, el, ctx) => {
  const rows = source.split('\n').filter((row) => row.length > 0);
  const table = el.createEl('table');
  // build table from CSV
});
```

### live preview support
- MarkdownPostProcessor does NOT run in live preview mode
- for live preview: need codemirror editor extensions
- this is intentionally separate because live preview uses different rendering engine

### MarkdownRenderChild
- use for complex rendered content that needs lifecycle management
- `ctx.addChild(new MyRenderChild(el))`

## 4. accessing file content/metadata

### vault.read(file) and vault.cachedRead(file)
- `cachedRead()` â†’ for display only, uses cache
- `read()` â†’ for read-modify-write operations
- use `read()` when you need to modify and save

```typescript
const content = await this.app.vault.cachedRead(file);
```

### vault.modify(file, content)
- writes content to file

### vault.process(file, callback)
- atomic read-modify-write
- callback receives current content, returns modified content
- PREFERRED for modifications to avoid race conditions

```typescript
vault.process(file, (data) => {
  return data.replace(':)', 'ðŸ™‚');
});
```

### getting files
- `vault.getMarkdownFiles()` â†’ all .md files
- `vault.getFiles()` â†’ all files
- `vault.getAbstractFileByPath(path)` â†’ specific file or folder
- check type: `file instanceof TFile` or `file instanceof TFolder`

### MetadataCache
- `app.metadataCache.getFileCache(file)` â†’ parsed frontmatter, links, etc
- returns `CachedMetadata` with:
  - `frontmatter` â†’ yaml properties
  - `frontmatterPosition` â†’ where frontmatter ends
  - `links`, `embeds`, `tags`, `headings`, etc

### getFrontMatterInfo(content)
- parses frontmatter position from raw content string
- returns `{ exists, contentStart, frontmatter }`

### accessing hidden folders (.obsidian)
- vault api doesn't expose hidden folders
- use `this.app.vault.adapter.read(path)` for adapter-level access
- `this.app.vault.adapter.list(path)` to list files in hidden folders

## 5. bases api (NEW in obsidian 1.9+)

### BasesView class
- extend `BasesView` for custom bases layouts (table, cards, list alternatives)
- NOT for regular plugin views
- uses `registerBasesView()` on plugin

```typescript
export const ExampleViewType = 'example-view';

export default class MyPlugin extends Plugin {
  async onload() {
    this.registerBasesView(ExampleViewType, {
      name: 'Example',
      icon: 'lucide-graduation-cap',
      factory: (controller, containerEl) => {
        new MyBasesView(controller, containerEl)
      },
      options: () => ([
        { type: 'text', displayName: 'Separator', key: 'separator', default: ' - ' }
      ])
    });
  }
}

export class MyBasesView extends BasesView {
  readonly type = ExampleViewType;
  private containerEl: HTMLElement;
  
  constructor(controller: QueryController, parentEl: HTMLElement) {
    super(controller);
    this.containerEl = parentEl.createDiv('bases-example-view-container');
  }
  
  public onDataUpdated(): void {
    // this.data.groupedData â†’ entries grouped
    // this.config.get('separator') â†’ user options
    // this.config.getOrder() â†’ property order
    
    for (const group of this.data.groupedData) {
      for (const entry of group.entries) {
        const value = entry.getValue(propertyName);
        // entry.file â†’ TFile
      }
    }
  }
}
```

### key bases types
- `BasesView` â†’ abstract class to extend
- `BasesViewConfig` â†’ access user config and order
- `BasesQueryResult` â†’ data returned to view
- `BasesEntryGroup` â†’ grouped entries
- `BasesEntry` â†’ single file entry with getValue()
- `QueryController` â†’ passed to constructor
- `BasesViewFactory` â†’ `(controller, containerEl) => BasesView`
- `BasesViewRegistration` â†’ full registration config

### ViewOption types for bases
- `text`, `toggle`, `dropdown`, etc.
- key â†’ saved to .base file
- displayName â†’ shown in ui
- default â†’ initial value

### accessing entry data
- `entry.getValue(propertyName)` â†’ returns Value object
- `entry.file` â†’ TFile reference
- `parsePropertyId(propertyName)` â†’ { type, name }
- type can be 'formula', 'note', 'file'

## events

### metadataCache events
- `'changed'` â†’ file metadata changed
- `'resolve'` â†’ links resolved
- `'resolved'` â†’ all links resolved

### vault events  
- `'create'` â†’ file/folder created
- `'modify'` â†’ file modified
- `'delete'` â†’ file/folder deleted
- `'rename'` â†’ file/folder renamed

```typescript
this.registerEvent(
  this.app.vault.on('modify', (file) => {
    console.log('Modified:', file.path);
  })
);
```

### workspace events
- `'file-open'` â†’ file opened
- `'active-leaf-change'` â†’ active pane changed
- `'layout-change'` â†’ workspace layout changed

## relevant for .spread spreadsheet plugin

for a spreadsheet view of .spread files:

1. **register the extension**: `this.registerExtensions(['spread'], SPREAD_VIEW_TYPE)`

2. **register a view**: either:
   - `TextFileView` if editing file content directly
   - `ItemView` if just displaying data
   
3. **read file content**: `vault.read()` or `vault.cachedRead()`

4. **watch for changes**: subscribe to vault 'modify' events

5. **for bases integration** (optional): `registerBasesView()` to add spreadsheet as a bases layout option

6. **markdownpostprocessor** could embed previews via code blocks like:
   ```
   ```spread
   path/to/file.spread
   ```
   ```

## sources
- https://docs.obsidian.md/Plugins/User+interface/Views
- https://docs.obsidian.md/Plugins/Vault
- https://docs.obsidian.md/Plugins/Editor/Markdown+post+processing
- https://docs.obsidian.md/plugins/guides/bases-view
- https://github.com/MeepTech/obsidian-custom-file-extensions-plugin
- forum discussions on registerExtensions
