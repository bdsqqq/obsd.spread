# obsidian view customization research

research for spread-view plugin - how to inject custom content into obsidian views.

## key apis for view customization

### 1. registerMarkdownPostProcessor
primary hook for modifying rendered markdown in reading view.

```typescript
this.registerMarkdownPostProcessor((element, context) => {
  // element = HTMLElement containing rendered markdown
  // context = MarkdownPostProcessorContext with sourcePath, frontmatter, etc.
  
  // modify DOM here - runs AFTER markdown->html conversion
  const codeblocks = element.findAll('code');
  for (let codeblock of codeblocks) {
    // transform elements
  }
});
```

**limitations:**
- only runs in reading view (not live preview)
- for live preview, need editor extensions (codemirror 6)

### 2. registerMarkdownCodeBlockProcessor
handles custom code blocks like ` ```dataview ` or ` ```datacards `

```typescript
this.registerMarkdownCodeBlockProcessor('spread', (source, el, ctx) => {
  // source = raw text inside code block
  // el = container element to render into
  // ctx = context with sourcePath
  
  // render custom content
  el.createEl('div', { cls: 'spread-container' });
});
```

**from dataview's approach:**
```typescript
// set priority with sortOrder
let registered = this.registerMarkdownCodeBlockProcessor(language, processor);
registered.sortOrder = priority;
```

### 3. custom ItemView for sidebar/panels
extend `ItemView` for custom panels (like file explorer alternatives).

```typescript
export class SpreadView extends ItemView {
  getViewType() { return 'spread-view'; }
  getDisplayText() { return 'Spread View'; }
  
  async onOpen() {
    const container = this.contentEl;
    container.empty();
    // build UI here
  }
  
  async onClose() {
    // cleanup
  }
}

// register in plugin onload:
this.registerView(VIEW_TYPE, (leaf) => new SpreadView(leaf));
```

### 4. MutationObserver patterns
for watching DOM changes and injecting content dynamically.

**from obsidian-image-captions:**
```typescript
this.observer = new MutationObserver((mutations: MutationRecord[]) => {
  mutations.forEach((rec: MutationRecord) => {
    if (rec.type === 'childList') {
      (rec.target as HTMLElement)
        .querySelectorAll('.image-embed, .video-embed')
        .forEach(async imageEmbedContainer => {
          // process elements
        });
    }
  });
});

this.observer.observe(document.body, {
  subtree: true,
  childList: true
});

// IMPORTANT: disconnect in onunload
onunload() {
  this.observer.disconnect();
}
```

**caveat from forum:** obsidian may remove/reinsert elements when scrolling (virtualization). MutationObserver may not catch this - elements get hidden/shown without DOM mutations.

### 5. workspace events
```typescript
// detect layout changes
this.registerEvent(
  this.app.workspace.on("layout-change", () => {
    // handle view mode switches, etc.
  })
);

// active file changes
this.registerEvent(
  this.app.workspace.on("file-open", (file) => {
    // file opened
  })
);

// iterate leaves
this.app.workspace.iterateAllLeaves(leaf => {
  if (leaf.view instanceof MarkdownView) {
    // do something
  }
});
```

## relevant plugins to study

### dataview (8.4k stars)
- uses `registerMarkdownCodeBlockProcessor` for `dataview` blocks
- complex indexing system for vault-wide queries
- exposes API globally: `window.DataviewAPI`
- github: blacksmithgu/obsidian-dataview

### datacards (126 stars)
- transforms dataview tables into card layouts
- uses `datacards` code block processor
- supports presets (grid, portrait, kanban)
- github: Sophokles187/data-cards

### image-captions (146 stars)
- uses MutationObserver to watch for `.image-embed` elements
- wraps images in `<figure>` with `<figcaption>`
- demonstrates cleanup pattern with `observer.disconnect()`
- github: alangrainger/obsidian-image-captions

### outliner-card-view
- converts bullet lists into browsable cards
- creates custom view panels
- github: Caffa/Outliner-Card-View-Obsidian-Plugin

### obsidian-projects (custom view api)
- allows other plugins to register custom views
- scans plugins for `onRegisterProjectView` method
- github: obsmd-projects/obsidian-projects

## live preview considerations

for live preview (editor), need codemirror 6 extensions:

```typescript
// from dataview
this.cmExtension = [];
this.registerEditorExtension(this.cmExtension);

// update extensions
this.cmExtension.length = 0;
this.cmExtension.push(inlinePlugin(this.app, this.index, this.settings, this.api));
this.app.workspace.updateOptions();
```

live preview uses different engine than reading view - more complex because you need to handle editing context.

## spread-view approach recommendation

for injecting content into existing note views:

1. **for code blocks:** use `registerMarkdownCodeBlockProcessor('spread', ...)`
2. **for inline content:** use `registerMarkdownPostProcessor` + MutationObserver fallback
3. **for sidebar panel:** create custom `ItemView`
4. **for live preview:** will need codemirror extensions (more complex)

start with reading view only, add live preview later.

## gotchas

- obsidian virtualizes content - elements may be removed/reinserted when scrolling
- postprocessors may fire multiple times for same content
- live preview requires separate codemirror extension implementation
- always disconnect observers in `onunload()`
- use `component.addChild()` for lifecycle management of rendered elements
